# Legitify Coolify Fabric Deployment
# Fabric-only stack intended to run alongside separate frontend/backend/Postgres services.

version: '3.8'

networks:
  legitify-network:
    name: fabric_test
    driver: bridge

volumes:
  fabric_data:
    name: legitify_fabric_data
  peer0_orgissuer:
    name: legitify_peer0_orgissuer
  peer0_orgverifier:
    name: legitify_peer0_orgverifier
  peer0_orgholder:
    name: legitify_peer0_orgholder
  orderer_data:
    name: legitify_orderer_data

services:
  # =============================================================================
  # FABRIC INITIALIZATION
  # =============================================================================
  fabric-init:
    image: ghcr.io/${GITHUB_REPOSITORY:-cdobey/legitify}-fabric-tools:latest
    container_name: fabric-init
    restart: 'no'
    working_dir: /src/ledger/scripts
    command: /bin/bash -c "./generate-crypto.sh"
    environment:
      ORDERER_HOSTS: ${ORDERER_HOSTS:-orderer.legitifyapp.com,orderer2.legitifyapp.com,orderer3.legitifyapp.com,orderer4.legitifyapp.com}
      ORDERER_MODE: ${ORDERER_MODE:-}
      FORCE_CRYPTO_REGEN: ${FORCE_CRYPTO_REGEN:-false}
    volumes:
      - fabric_data:/data
    networks:
      - legitify-network

  # =============================================================================
  # ORDERER
  # =============================================================================
  orderer.legitifyapp.com:
    image: hyperledger/fabric-orderer:2.5.10
    container_name: orderer.legitifyapp.com
    restart: unless-stopped
    environment:
      - FABRIC_LOGGING_SPEC=INFO
      - ORDERER_GENERAL_LISTENADDRESS=0.0.0.0
      - ORDERER_GENERAL_LISTENPORT=7050
      - ORDERER_GENERAL_LOCALMSPID=OrdererMSP
      - ORDERER_GENERAL_LOCALMSPDIR=/data/organizations/ordererOrganizations/legitifyapp.com/orderers/orderer.legitifyapp.com/msp
      - ORDERER_GENERAL_TLS_ENABLED=true
      - ORDERER_GENERAL_TLS_PRIVATEKEY=/data/organizations/ordererOrganizations/legitifyapp.com/orderers/orderer.legitifyapp.com/tls/server.key
      - ORDERER_GENERAL_TLS_CERTIFICATE=/data/organizations/ordererOrganizations/legitifyapp.com/orderers/orderer.legitifyapp.com/tls/server.crt
      - ORDERER_GENERAL_TLS_ROOTCAS=[/data/organizations/ordererOrganizations/legitifyapp.com/orderers/orderer.legitifyapp.com/tls/ca.crt]
      - ORDERER_GENERAL_CLUSTER_CLIENTCERTIFICATE=/data/organizations/ordererOrganizations/legitifyapp.com/orderers/orderer.legitifyapp.com/tls/server.crt
      - ORDERER_GENERAL_CLUSTER_CLIENTPRIVATEKEY=/data/organizations/ordererOrganizations/legitifyapp.com/orderers/orderer.legitifyapp.com/tls/server.key
      - ORDERER_GENERAL_CLUSTER_ROOTCAS=[/data/organizations/ordererOrganizations/legitifyapp.com/orderers/orderer.legitifyapp.com/tls/ca.crt]
      - ORDERER_GENERAL_BOOTSTRAPMETHOD=none
      - ORDERER_CHANNELPARTICIPATION_ENABLED=true
      - ORDERER_ADMIN_LISTENADDRESS=0.0.0.0:7053
      - ORDERER_ADMIN_TLS_ENABLED=true
      - ORDERER_ADMIN_TLS_CERTIFICATE=/data/organizations/ordererOrganizations/legitifyapp.com/orderers/orderer.legitifyapp.com/tls/server.crt
      - ORDERER_ADMIN_TLS_PRIVATEKEY=/data/organizations/ordererOrganizations/legitifyapp.com/orderers/orderer.legitifyapp.com/tls/server.key
      - ORDERER_ADMIN_TLS_ROOTCAS=[/data/organizations/ordererOrganizations/legitifyapp.com/orderers/orderer.legitifyapp.com/tls/ca.crt]
      - ORDERER_ADMIN_TLS_CLIENTAUTHREQUIRED=true
      - ORDERER_ADMIN_TLS_CLIENTROOTCAS=[/data/organizations/ordererOrganizations/legitifyapp.com/orderers/orderer.legitifyapp.com/tls/ca.crt]
      - FABRIC_CFG_PATH=/data/config
    volumes:
      - fabric_data:/data
      - orderer_data:/var/hyperledger/production/orderer
    networks:
      - legitify-network
    depends_on:
      fabric-init:
        condition: service_completed_successfully
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 1G

  # =============================================================================
  # WAIT SERVICE - Ensures orderer is ready before peers start
  # =============================================================================
  orderer-wait:
    image: busybox:latest
    container_name: orderer-wait
    restart: 'no'
    command: sh -c "sleep 15"
    networks:
      - legitify-network
    depends_on:
      - orderer.legitifyapp.com

  # =============================================================================
  # PEERS
  # =============================================================================
  peer0.orgissuer.com:
    image: hyperledger/fabric-peer:2.5.10
    container_name: peer0.orgissuer.com
    restart: unless-stopped
    environment:
      - CORE_VM_ENDPOINT=unix:///var/run/docker.sock
      - FABRIC_LOGGING_SPEC=INFO
      - CORE_PEER_TLS_ENABLED=true
      - CORE_PEER_ID=peer0.orgissuer.com
      - CORE_PEER_ADDRESS=peer0.orgissuer.com:7051
      - CORE_PEER_LISTENADDRESS=0.0.0.0:7051
      - CORE_PEER_CHAINCODEADDRESS=peer0.orgissuer.com:7052
      - CORE_PEER_CHAINCODELISTENADDRESS=0.0.0.0:7052
      - CORE_PEER_LOCALMSPID=OrgIssuerMSP
      - CORE_PEER_MSPCONFIGPATH=/data/organizations/peerOrganizations/orgissuer.com/peers/peer0.orgissuer.com/msp
      - CORE_PEER_TLS_CERT_FILE=/data/organizations/peerOrganizations/orgissuer.com/peers/peer0.orgissuer.com/tls/server.crt
      - CORE_PEER_TLS_KEY_FILE=/data/organizations/peerOrganizations/orgissuer.com/peers/peer0.orgissuer.com/tls/server.key
      - CORE_PEER_TLS_ROOTCERT_FILE=/data/organizations/peerOrganizations/orgissuer.com/peers/peer0.orgissuer.com/tls/ca.crt
      - FABRIC_CFG_PATH=/data/config
    volumes:
      - fabric_data:/data
      - peer0_orgissuer:/var/hyperledger/production
      - /var/run/docker.sock:/var/run/docker.sock
    networks:
      - legitify-network
    depends_on:
      orderer-wait:
        condition: service_completed_successfully
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 1G

  peer0.orgverifier.com:
    image: hyperledger/fabric-peer:2.5.10
    container_name: peer0.orgverifier.com
    restart: unless-stopped
    environment:
      - CORE_VM_ENDPOINT=unix:///var/run/docker.sock
      - FABRIC_LOGGING_SPEC=INFO
      - CORE_PEER_TLS_ENABLED=true
      - CORE_PEER_ID=peer0.orgverifier.com
      - CORE_PEER_ADDRESS=peer0.orgverifier.com:8051
      - CORE_PEER_LISTENADDRESS=0.0.0.0:8051
      - CORE_PEER_CHAINCODEADDRESS=peer0.orgverifier.com:8052
      - CORE_PEER_CHAINCODELISTENADDRESS=0.0.0.0:8052
      - CORE_PEER_LOCALMSPID=OrgVerifierMSP
      - CORE_PEER_MSPCONFIGPATH=/data/organizations/peerOrganizations/orgverifier.com/peers/peer0.orgverifier.com/msp
      - CORE_PEER_TLS_CERT_FILE=/data/organizations/peerOrganizations/orgverifier.com/peers/peer0.orgverifier.com/tls/server.crt
      - CORE_PEER_TLS_KEY_FILE=/data/organizations/peerOrganizations/orgverifier.com/peers/peer0.orgverifier.com/tls/server.key
      - CORE_PEER_TLS_ROOTCERT_FILE=/data/organizations/peerOrganizations/orgverifier.com/peers/peer0.orgverifier.com/tls/ca.crt
      - FABRIC_CFG_PATH=/data/config
    volumes:
      - fabric_data:/data
      - peer0_orgverifier:/var/hyperledger/production
      - /var/run/docker.sock:/var/run/docker.sock
    networks:
      - legitify-network
    depends_on:
      orderer-wait:
        condition: service_completed_successfully
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 1G

  peer0.orgholder.com:
    image: hyperledger/fabric-peer:2.5.10
    container_name: peer0.orgholder.com
    restart: unless-stopped
    environment:
      - CORE_VM_ENDPOINT=unix:///var/run/docker.sock
      - FABRIC_LOGGING_SPEC=INFO
      - CORE_PEER_TLS_ENABLED=true
      - CORE_PEER_ID=peer0.orgholder.com
      - CORE_PEER_ADDRESS=peer0.orgholder.com:9051
      - CORE_PEER_LISTENADDRESS=0.0.0.0:9051
      - CORE_PEER_CHAINCODEADDRESS=peer0.orgholder.com:9052
      - CORE_PEER_CHAINCODELISTENADDRESS=0.0.0.0:9052
      - CORE_PEER_LOCALMSPID=OrgHolderMSP
      - CORE_PEER_MSPCONFIGPATH=/data/organizations/peerOrganizations/orgholder.com/peers/peer0.orgholder.com/msp
      - CORE_PEER_TLS_CERT_FILE=/data/organizations/peerOrganizations/orgholder.com/peers/peer0.orgholder.com/tls/server.crt
      - CORE_PEER_TLS_KEY_FILE=/data/organizations/peerOrganizations/orgholder.com/peers/peer0.orgholder.com/tls/server.key
      - CORE_PEER_TLS_ROOTCERT_FILE=/data/organizations/peerOrganizations/orgholder.com/peers/peer0.orgholder.com/tls/ca.crt
      - FABRIC_CFG_PATH=/data/config
    volumes:
      - fabric_data:/data
      - peer0_orgholder:/var/hyperledger/production
      - /var/run/docker.sock:/var/run/docker.sock
    networks:
      - legitify-network
    depends_on:
      orderer-wait:
        condition: service_completed_successfully
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 1G

  # =============================================================================
  # WAIT SERVICE - Ensures peers are ready before CLI starts
  # =============================================================================
  peer-wait:
    image: busybox:latest
    container_name: peer-wait
    restart: 'no'
    command: sh -c "sleep 20"
    networks:
      - legitify-network
    depends_on:
      - peer0.orgissuer.com
      - peer0.orgverifier.com
      - peer0.orgholder.com

  # =============================================================================
  # FABRIC CLI - Channel Initialization
  # =============================================================================
  fabric-cli:
    image: ghcr.io/${GITHUB_REPOSITORY:-cdobey/legitify}-fabric-tools:latest
    container_name: fabric-cli
    restart: 'no'
    working_dir: /src/ledger/scripts
    command: /bin/bash -c "./init-channel.sh"
    environment:
      ORDERER_HOSTS: ${ORDERER_HOSTS:-orderer.legitifyapp.com,orderer2.legitifyapp.com,orderer3.legitifyapp.com,orderer4.legitifyapp.com}
    volumes:
      - fabric_data:/data
      - /var/run/docker.sock:/host/var/run/docker.sock
    networks:
      - legitify-network
    depends_on:
      peer-wait:
        condition: service_completed_successfully

  # =============================================================================
  # CHAINCODE
  # =============================================================================
  credential-chaincode:
    image: ghcr.io/${GITHUB_REPOSITORY:-cdobey/legitify}-chaincode:latest
    container_name: credential-chaincode
    restart: unless-stopped
    environment:
      - CHAINCODE_SERVER_ADDRESS=0.0.0.0:9999
    ports:
      - '9999:9999'
    volumes:
      - fabric_data:/data:ro
    networks:
      - legitify-network
    depends_on:
      fabric-cli:
        condition: service_completed_successfully
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 512M
