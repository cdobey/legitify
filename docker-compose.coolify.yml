# Legitify Coolify Production Deployment - SIMPLIFIED
# Uses timed delays instead of health checks for Fabric components

version: '3.8'

networks:
  legitify-network:
    name: fabric_test
    driver: bridge
  coolify:
    external: true
    name: coolify

volumes:
  pgdata:
  fabric_data:
  peer0_orgissuer:
  peer0_orgverifier:
  peer0_orgholder:
  orderer_data:

services:
  # =============================================================================
  # DATABASE
  # =============================================================================
  postgres:
    image: postgres:15-alpine
    container_name: legitify-db
    restart: unless-stopped
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-postgres}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:?POSTGRES_PASSWORD is required}
      POSTGRES_DB: ${POSTGRES_DB:-legitify}
    volumes:
      - pgdata:/var/lib/postgresql/data
    healthcheck:
      test: ['CMD-SHELL', 'pg_isready -U postgres']
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    networks:
      - legitify-network
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 1G

  # =============================================================================
  # FABRIC INITIALIZATION
  # =============================================================================
  fabric-init:
    image: ghcr.io/${GITHUB_REPOSITORY:-cdobey/legitify}-fabric-tools:latest
    container_name: fabric-init
    restart: 'no'
    working_dir: /src/ledger/scripts
    command: /bin/bash -c "./generate-crypto.sh"
    environment:
      ORDERER_HOSTS: ${ORDERER_HOSTS:-orderer.legitifyapp.com,orderer2.legitifyapp.com,orderer3.legitifyapp.com,orderer4.legitifyapp.com}
      ORDERER_MODE: ${ORDERER_MODE:-}
      FORCE_CRYPTO_REGEN: ${FORCE_CRYPTO_REGEN:-false}
    volumes:
      - fabric_data:/data
    networks:
      - legitify-network

  # =============================================================================
  # ORDERER
  # =============================================================================
  orderer.legitifyapp.com:
    image: hyperledger/fabric-orderer:2.5.10
    container_name: orderer.legitifyapp.com
    restart: unless-stopped
    environment:
      - FABRIC_LOGGING_SPEC=INFO
      - ORDERER_GENERAL_LISTENADDRESS=0.0.0.0
      - ORDERER_GENERAL_LISTENPORT=7050
      - ORDERER_GENERAL_LOCALMSPID=OrdererMSP
      - ORDERER_GENERAL_LOCALMSPDIR=/data/organizations/ordererOrganizations/legitifyapp.com/orderers/orderer.legitifyapp.com/msp
      - ORDERER_GENERAL_TLS_ENABLED=true
      - ORDERER_GENERAL_TLS_PRIVATEKEY=/data/organizations/ordererOrganizations/legitifyapp.com/orderers/orderer.legitifyapp.com/tls/server.key
      - ORDERER_GENERAL_TLS_CERTIFICATE=/data/organizations/ordererOrganizations/legitifyapp.com/orderers/orderer.legitifyapp.com/tls/server.crt
      - ORDERER_GENERAL_TLS_ROOTCAS=[/data/organizations/ordererOrganizations/legitifyapp.com/orderers/orderer.legitifyapp.com/tls/ca.crt]
      - ORDERER_GENERAL_CLUSTER_CLIENTCERTIFICATE=/data/organizations/ordererOrganizations/legitifyapp.com/orderers/orderer.legitifyapp.com/tls/server.crt
      - ORDERER_GENERAL_CLUSTER_CLIENTPRIVATEKEY=/data/organizations/ordererOrganizations/legitifyapp.com/orderers/orderer.legitifyapp.com/tls/server.key
      - ORDERER_GENERAL_CLUSTER_ROOTCAS=[/data/organizations/ordererOrganizations/legitifyapp.com/orderers/orderer.legitifyapp.com/tls/ca.crt]
      - ORDERER_GENERAL_BOOTSTRAPMETHOD=none
      - ORDERER_CHANNELPARTICIPATION_ENABLED=true
      - ORDERER_ADMIN_LISTENADDRESS=0.0.0.0:7053
      - ORDERER_ADMIN_TLS_ENABLED=true
      - ORDERER_ADMIN_TLS_CERTIFICATE=/data/organizations/ordererOrganizations/legitifyapp.com/orderers/orderer.legitifyapp.com/tls/server.crt
      - ORDERER_ADMIN_TLS_PRIVATEKEY=/data/organizations/ordererOrganizations/legitifyapp.com/orderers/orderer.legitifyapp.com/tls/server.key
      - ORDERER_ADMIN_TLS_ROOTCAS=[/data/organizations/ordererOrganizations/legitifyapp.com/orderers/orderer.legitifyapp.com/tls/ca.crt]
      - ORDERER_ADMIN_TLS_CLIENTAUTHREQUIRED=true
      - ORDERER_ADMIN_TLS_CLIENTROOTCAS=[/data/organizations/ordererOrganizations/legitifyapp.com/orderers/orderer.legitifyapp.com/tls/ca.crt]
      - FABRIC_CFG_PATH=/data/config
    volumes:
      - fabric_data:/data
      - orderer_data:/var/hyperledger/production/orderer
    networks:
      - legitify-network
    depends_on:
      fabric-init:
        condition: service_completed_successfully
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 1G

  # =============================================================================
  # WAIT SERVICE - Ensures orderer is ready before peers start
  # =============================================================================
  orderer-wait:
    image: curlimages/curl:8.6.0
    container_name: orderer-wait
    restart: 'no'
    command: sh -c "until curl -sf http://orderer.legitifyapp.com:9443/healthz; do echo 'waiting for orderer...'; sleep 2; done"
    networks:
      - legitify-network
    depends_on:
      - orderer.legitifyapp.com

  # =============================================================================
  # PEERS
  # =============================================================================
  peer0.orgissuer.com:
    image: hyperledger/fabric-peer:2.5.10
    container_name: peer0.orgissuer.com
    restart: unless-stopped
    environment:
      - CORE_VM_ENDPOINT=unix:///var/run/docker.sock
      - FABRIC_LOGGING_SPEC=INFO
      - CORE_PEER_TLS_ENABLED=true
      - CORE_PEER_ID=peer0.orgissuer.com
      - CORE_PEER_ADDRESS=peer0.orgissuer.com:7051
      - CORE_PEER_LISTENADDRESS=0.0.0.0:7051
      - CORE_PEER_CHAINCODEADDRESS=peer0.orgissuer.com:7052
      - CORE_PEER_CHAINCODELISTENADDRESS=0.0.0.0:7052
      - CORE_PEER_LOCALMSPID=OrgIssuerMSP
      - CORE_PEER_MSPCONFIGPATH=/data/organizations/peerOrganizations/orgissuer.com/peers/peer0.orgissuer.com/msp
      - CORE_PEER_TLS_CERT_FILE=/data/organizations/peerOrganizations/orgissuer.com/peers/peer0.orgissuer.com/tls/server.crt
      - CORE_PEER_TLS_KEY_FILE=/data/organizations/peerOrganizations/orgissuer.com/peers/peer0.orgissuer.com/tls/server.key
      - CORE_PEER_TLS_ROOTCERT_FILE=/data/organizations/peerOrganizations/orgissuer.com/peers/peer0.orgissuer.com/tls/ca.crt
      - CORE_PEER_GOSSIP_ENDPOINT=peer0.orgissuer.com:7051
      - CORE_PEER_GOSSIP_EXTERNALENDPOINT=peer0.orgissuer.com:7051
      - CORE_PEER_GOSSIP_BOOTSTRAP=peer0.orgissuer.com:7051
      - CORE_OPERATIONS_LISTENADDRESS=0.0.0.0:9443
      - FABRIC_CFG_PATH=/data/config
    volumes:
      - fabric_data:/data
      - peer0_orgissuer:/var/hyperledger/production
      - /var/run/docker.sock:/var/run/docker.sock
    networks:
      - legitify-network
    depends_on:
      orderer-wait:
        condition: service_completed_successfully
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 1G

  peer0.orgverifier.com:
    image: hyperledger/fabric-peer:2.5.10
    container_name: peer0.orgverifier.com
    restart: unless-stopped
    environment:
      - CORE_VM_ENDPOINT=unix:///var/run/docker.sock
      - FABRIC_LOGGING_SPEC=INFO
      - CORE_PEER_TLS_ENABLED=true
      - CORE_PEER_ID=peer0.orgverifier.com
      - CORE_PEER_ADDRESS=peer0.orgverifier.com:8051
      - CORE_PEER_LISTENADDRESS=0.0.0.0:8051
      - CORE_PEER_CHAINCODEADDRESS=peer0.orgverifier.com:8052
      - CORE_PEER_CHAINCODELISTENADDRESS=0.0.0.0:8052
      - CORE_PEER_LOCALMSPID=OrgVerifierMSP
      - CORE_PEER_MSPCONFIGPATH=/data/organizations/peerOrganizations/orgverifier.com/peers/peer0.orgverifier.com/msp
      - CORE_PEER_TLS_CERT_FILE=/data/organizations/peerOrganizations/orgverifier.com/peers/peer0.orgverifier.com/tls/server.crt
      - CORE_PEER_TLS_KEY_FILE=/data/organizations/peerOrganizations/orgverifier.com/peers/peer0.orgverifier.com/tls/server.key
      - CORE_PEER_TLS_ROOTCERT_FILE=/data/organizations/peerOrganizations/orgverifier.com/peers/peer0.orgverifier.com/tls/ca.crt
      - CORE_PEER_GOSSIP_ENDPOINT=peer0.orgverifier.com:8051
      - CORE_PEER_GOSSIP_EXTERNALENDPOINT=peer0.orgverifier.com:8051
      - CORE_PEER_GOSSIP_BOOTSTRAP=peer0.orgverifier.com:8051
      - CORE_OPERATIONS_LISTENADDRESS=0.0.0.0:9443
      - FABRIC_CFG_PATH=/data/config
    volumes:
      - fabric_data:/data
      - peer0_orgverifier:/var/hyperledger/production
      - /var/run/docker.sock:/var/run/docker.sock
    networks:
      - legitify-network
    depends_on:
      orderer-wait:
        condition: service_completed_successfully
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 1G

  peer0.orgholder.com:
    image: hyperledger/fabric-peer:2.5.10
    container_name: peer0.orgholder.com
    restart: unless-stopped
    environment:
      - CORE_VM_ENDPOINT=unix:///var/run/docker.sock
      - FABRIC_LOGGING_SPEC=INFO
      - CORE_PEER_TLS_ENABLED=true
      - CORE_PEER_ID=peer0.orgholder.com
      - CORE_PEER_ADDRESS=peer0.orgholder.com:9051
      - CORE_PEER_LISTENADDRESS=0.0.0.0:9051
      - CORE_PEER_CHAINCODEADDRESS=peer0.orgholder.com:9052
      - CORE_PEER_CHAINCODELISTENADDRESS=0.0.0.0:9052
      - CORE_PEER_LOCALMSPID=OrgHolderMSP
      - CORE_PEER_MSPCONFIGPATH=/data/organizations/peerOrganizations/orgholder.com/peers/peer0.orgholder.com/msp
      - CORE_PEER_TLS_CERT_FILE=/data/organizations/peerOrganizations/orgholder.com/peers/peer0.orgholder.com/tls/server.crt
      - CORE_PEER_TLS_KEY_FILE=/data/organizations/peerOrganizations/orgholder.com/peers/peer0.orgholder.com/tls/server.key
      - CORE_PEER_TLS_ROOTCERT_FILE=/data/organizations/peerOrganizations/orgholder.com/peers/peer0.orgholder.com/tls/ca.crt
      - CORE_PEER_GOSSIP_ENDPOINT=peer0.orgholder.com:9051
      - CORE_PEER_GOSSIP_EXTERNALENDPOINT=peer0.orgholder.com:9051
      - CORE_PEER_GOSSIP_BOOTSTRAP=peer0.orgholder.com:9051
      - CORE_OPERATIONS_LISTENADDRESS=0.0.0.0:9443
      - FABRIC_CFG_PATH=/data/config
    volumes:
      - fabric_data:/data
      - peer0_orgholder:/var/hyperledger/production
      - /var/run/docker.sock:/var/run/docker.sock
    networks:
      - legitify-network
    depends_on:
      orderer-wait:
        condition: service_completed_successfully
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 1G

  # =============================================================================
  # WAIT SERVICE - Ensures peers are ready before CLI starts
  # =============================================================================
  peer-wait:
    image: curlimages/curl:8.6.0
    container_name: peer-wait
    restart: 'no'
    command: sh -c "until curl -sf http://peer0.orgissuer.com:9443/healthz && curl -sf http://peer0.orgverifier.com:9443/healthz && curl -sf http://peer0.orgholder.com:9443/healthz; do echo 'waiting for peers...'; sleep 2; done"
    networks:
      - legitify-network
    depends_on:
      - peer0.orgissuer.com
      - peer0.orgverifier.com
      - peer0.orgholder.com

  # =============================================================================
  # FABRIC CLI - Channel Initialization
  # =============================================================================
  fabric-cli:
    image: ghcr.io/${GITHUB_REPOSITORY:-cdobey/legitify}-fabric-tools:latest
    container_name: fabric-cli
    restart: 'no'
    working_dir: /src/ledger/scripts
    command: /bin/bash -c "./init-channel.sh"
    environment:
      ORDERER_HOSTS: ${ORDERER_HOSTS:-orderer.legitifyapp.com,orderer2.legitifyapp.com,orderer3.legitifyapp.com,orderer4.legitifyapp.com}
    volumes:
      - fabric_data:/data
      - /var/run/docker.sock:/host/var/run/docker.sock
    networks:
      - legitify-network
    depends_on:
      peer-wait:
        condition: service_completed_successfully

  # =============================================================================
  # CHAINCODE
  # =============================================================================
  credential-chaincode:
    image: ghcr.io/${GITHUB_REPOSITORY:-cdobey/legitify}-chaincode:latest
    container_name: credential-chaincode
    restart: unless-stopped
    environment:
      - CHAINCODE_SERVER_ADDRESS=0.0.0.0:9999
    ports:
      - '9999:9999'
    volumes:
      - fabric_data:/data:ro
    networks:
      - legitify-network
    depends_on:
      fabric-cli:
        condition: service_completed_successfully
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 512M

  # =============================================================================
  # BACKEND API
  # =============================================================================
  backend:
    image: ghcr.io/${GITHUB_REPOSITORY:-cdobey/legitify}-backend:latest
    container_name: legitify-backend
    restart: unless-stopped
    environment:
      NODE_ENV: production
      SERVER_PORT: 3001
      IS_DEPLOYMENT: 'true'
      POSTGRES_CONNECTION_URL: postgresql://${POSTGRES_USER:-postgres}:${POSTGRES_PASSWORD}@postgres:5432/${POSTGRES_DB:-legitify}
      JWT_SECRET: ${JWT_SECRET:?JWT_SECRET is required}
      API_URL: https://${BACKEND_DOMAIN:-api-legitify.dobey.dev}
      MOCK_LEDGER: 'false'
      FRONTEND_URL: https://${FRONTEND_DOMAIN:-legitify.dobey.dev}
      FABRIC_CERTIFICATES_PATH: /app/fabric-data/organizations/peerOrganizations
    ports:
      - '3001:3001'
    depends_on:
      postgres:
        condition: service_healthy
      fabric-cli:
        condition: service_completed_successfully
      credential-chaincode:
        condition: service_started
    volumes:
      - fabric_data:/app/fabric-data:ro
    networks:
      - legitify-network
      - coolify
    healthcheck:
      test: ['CMD-SHELL', 'curl -f http://localhost:3001/health || exit 1']
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    labels:
      - 'traefik.enable=true'
      - 'traefik.docker.network=coolify'
      - 'traefik.http.routers.legitify-backend.rule=Host(`api-legitify.dobey.dev`)'
      - 'traefik.http.routers.legitify-backend.tls=true'
      - 'traefik.http.services.legitify-backend.loadbalancer.server.port=3001'
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 2G

  # =============================================================================
  # FRONTEND
  # =============================================================================
  frontend:
    image: ghcr.io/${GITHUB_REPOSITORY:-cdobey/legitify}-frontend:latest
    container_name: legitify-frontend
    restart: unless-stopped
    environment:
      VITE_API_URL: https://${BACKEND_DOMAIN:-api-legitify.dobey.dev}
    ports:
      - '3000:80'
    depends_on:
      backend:
        condition: service_healthy
    networks:
      - legitify-network
      - coolify
    healthcheck:
      test: ['CMD-SHELL', 'curl -f http://localhost:80 || exit 1']
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 20s
    labels:
      - 'traefik.enable=true'
      - 'traefik.docker.network=coolify'
      - 'traefik.http.routers.legitify-frontend.rule=Host(`legitify.dobey.dev`)'
      - 'traefik.http.routers.legitify-frontend.tls=true'
      - 'traefik.http.services.legitify-frontend.loadbalancer.server.port=80'
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 512M
