datasource db {
  provider = "postgresql"
  url      = env("POSTGRES_CONNECTION_URL")
}

generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "linux-arm64-openssl-3.0.x"]
}

model User {
  id           String      @id @default(uuid())
  username     String      @unique
  email        String      @unique
  role         Role
  orgName      OrgName
  createdAt    DateTime    @default(now())
  updatedAt    DateTime    @updatedAt

  // Relations
  issuedDocuments     Document[] @relation("Issuer")
  receivedDocuments   Document[] @relation("IssuedTo")
  requests            Request[]  @relation("Requester")
  ownedUniversities   University[] @relation("UniversityOwner")
  affiliations        Affiliation[] @relation("UserAffiliation")
  sentJoinRequests    UniversityJoinRequest[] @relation("UniversityJoinRequester")
  memberOfUniversities University[] @relation("UniversityMembers")
}

// New model for University sub-organizations
model University {
  id          String      @id @default(uuid())
  name        String
  displayName String      
  description String?
  logoUrl     String?
  ownerId     String
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  // Relations
  owner        User         @relation("UniversityOwner", fields: [ownerId], references: [id])
  affiliations Affiliation[] @relation("UniversityAffiliation")
  joinRequests UniversityJoinRequest[] @relation("UniversityJoinTarget")
  members      User[]       @relation("UniversityMembers")
  documents    Document[]   @relation("UniversityDocuments")

  @@unique([name, ownerId])
}

// New model for User-University affiliations
model Affiliation {
  id           String    @id @default(uuid())
  userId       String
  universityId String
  role         String    @default("student") // student, admin, etc.
  status       AffiliationStatus @default(pending)
  initiatedBy  String?   @default("student") // Who initiated: "student" or "university"
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  // Relations
  user        User       @relation("UserAffiliation", fields: [userId], references: [id])
  university  University @relation("UniversityAffiliation", fields: [universityId], references: [id])

  @@unique([userId, universityId])
}

model Document {
  id               String         @id @default(uuid())
  issuedTo         String
  issuer           String
  fileData         Bytes?         // Store as binary
  status           DocumentStatus @default(issued)
  createdAt        DateTime       @default(now())
  updatedAt        DateTime       @updatedAt
  
  // University that issued the degree
  universityId     String?
  university       University?    @relation("UniversityDocuments", fields: [universityId], references: [id])
  
  // Academic detail fields
  degreeTitle      String?        // e.g., "Bachelor of Science"
  fieldOfStudy     String?        // e.g., "Computer Science" 
  graduationDate   DateTime?      // When the degree was earned
  honors           String?        // e.g., "Cum Laude", "First Class"
  studentId        String?        // Student's university ID
  programDuration  String?        // e.g., "4 years"
  gpa              Float?         // Grade Point Average
  additionalNotes  String?        // Any additional information

  // Relations
  issuerUser    User      @relation("Issuer", fields: [issuer], references: [id])
  issuedToUser  User      @relation("IssuedTo", fields: [issuedTo], references: [id])
  requests      Request[] @relation("Document")
}

model Request {
  id          String    @id @default(uuid())
  requesterId String
  documentId  String
  status      RequestStatus @default(pending)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  // Relations
  requester User     @relation("Requester", fields: [requesterId], references: [id])
  document  Document @relation("Document", fields: [documentId], references: [id])
}

model WalletIdentity {
  label       String   @id
  orgName     OrgName
  type        String   // e.g., "X.509"
  certificate String   @db.Text
  privateKey  String   @db.Text
  mspId       String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([label, orgName])
}

enum Role {
  university
  individual
  employer
}

enum OrgName {
  orguniversity
  orgindividual
  orgemployer
}

enum DocumentStatus {
  issued
  accepted
  denied
}

enum RequestStatus {
  pending
  granted
  denied
}

// New enum for affiliation status
enum AffiliationStatus {
  pending
  active
  rejected
}

// New model for university join requests
model UniversityJoinRequest {
  id          String    @id @default(uuid())
  requesterId String
  universityId String
  status      String    @default("pending") // pending, approved, rejected
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  // Relations
  requester   User      @relation("UniversityJoinRequester", fields: [requesterId], references: [id])
  university  University @relation("UniversityJoinTarget", fields: [universityId], references: [id])
}
