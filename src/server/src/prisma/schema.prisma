datasource db {
  provider = "postgresql"
  url      = env("POSTGRES_CONNECTION_URL")
}

generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "linux-arm64-openssl-3.0.x"]
}

model User {
  id               String      @id @default(uuid())
  username         String      @unique
  email            String      @unique
  role             Role
  orgName          OrgName
  profilePictureUrl String?    
  createdAt        DateTime    @default(now())
  updatedAt        DateTime    @updatedAt
  
  twoFactorEnabled Boolean @default(false)
  twoFactorSecret String? // Stored temporarily during setup or permanently when enabled

  // Relations
  issuedDocuments         Document[] @relation("Issuer")
  receivedDocuments       Document[] @relation("IssuedTo")
  requests                Request[]  @relation("Requester")
  ownedUniversities       University[] @relation("UniversityOwner")
  sentJoinRequests        UniversityJoinRequest[] @relation("UniversityJoinRequester")
  
  // University administration relationships
  universityMemberships   UniversityMember[] @relation("UniversityMember")
  
  // University student relationships
  studentAffiliations     StudentAffiliation[] @relation("StudentAffiliation")
}

// New model for University sub-organizations
model University {
  id          String      @id @default(uuid())
  name        String
  displayName String      
  description String?
  logoUrl     String?
  ownerId     String
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  // Relations
  owner         User                  @relation("UniversityOwner", fields: [ownerId], references: [id])
  joinRequests  UniversityJoinRequest[] @relation("UniversityJoinTarget")
  documents     Document[]            @relation("UniversityDocuments")
  
  // University administrators relationship
  members       UniversityMember[]    @relation("UniversityMembers")
  
  // Student affiliations relationship
  students      StudentAffiliation[]  @relation("UniversityStudents")

  @@unique([name, ownerId])
}

// Model for University Members (university users who can administer the university)
model UniversityMember {
  id           String    @id @default(uuid())
  userId       String
  universityId String
  role         String    @default("admin") // admin or other roles in the future
  status       MembershipStatus @default(pending)
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  // Relations
  user        User       @relation("UniversityMember", fields: [userId], references: [id])
  university  University @relation("UniversityMembers", fields: [universityId], references: [id])

  @@unique([userId, universityId])
}

// Model for Student-University affiliations
model StudentAffiliation {
  id           String    @id @default(uuid())
  userId       String
  universityId String
  status       AffiliationStatus @default(pending)
  initiatedBy  String?   @default("student") // Who initiated: "student" or "university"
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  // Relations
  student     User       @relation("StudentAffiliation", fields: [userId], references: [id])
  university  University @relation("UniversityStudents", fields: [universityId], references: [id])

  @@unique([userId, universityId])
}

model Document {
  id               String         @id @default(uuid())
  issuedTo         String
  issuer           String
  fileData         Bytes?         // Store as binary
  status           DocumentStatus @default(issued)
  createdAt        DateTime       @default(now())
  updatedAt        DateTime       @updatedAt
  
  // University that issued the degree
  universityId     String?
  university       University?    @relation("UniversityDocuments", fields: [universityId], references: [id])
  
  // Academic detail fields
  degreeTitle      String?        // e.g., "Bachelor of Science"
  fieldOfStudy     String?        // e.g., "Computer Science" 
  graduationDate   DateTime?      // When the degree was earned
  honors           String?        // e.g., "Cum Laude", "First Class"
  studentId        String?        // Student's university ID
  programDuration  String?        // e.g., "4 years"
  gpa              Float?         // Grade Point Average
  additionalNotes  String?        // Any additional information

  // Relations
  issuerUser    User      @relation("Issuer", fields: [issuer], references: [id])
  issuedToUser  User      @relation("IssuedTo", fields: [issuedTo], references: [id])
  requests      Request[] @relation("Document")
}

model Request {
  id          String    @id @default(uuid())
  requesterId String
  documentId  String
  status      RequestStatus @default(pending)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  // Relations
  requester User     @relation("Requester", fields: [requesterId], references: [id])
  document  Document @relation("Document", fields: [documentId], references: [id])
}

model WalletIdentity {
  label       String   @id
  orgName     OrgName
  type        String   // e.g., "X.509"
  certificate String   @db.Text
  privateKey  String   @db.Text
  mspId       String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([label, orgName])
}

enum Role {
  university
  individual
  employer
}

enum OrgName {
  orguniversity
  orgindividual
  orgemployer
}

enum DocumentStatus {
  issued
  accepted
  denied
}

enum RequestStatus {
  pending
  granted
  denied
}

// New enum for student affiliation status
enum AffiliationStatus {
  pending
  active
  rejected
}

// New enum for university membership status
enum MembershipStatus {
  pending
  active
  rejected
}

// Model for university join requests
model UniversityJoinRequest {
  id          String    @id @default(uuid())
  requesterId String
  universityId String
  status      String    @default("pending") // pending, approved, rejected
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  // Relations
  requester   User      @relation("UniversityJoinRequester", fields: [requesterId], references: [id])
  university  University @relation("UniversityJoinTarget", fields: [universityId], references: [id])
}
