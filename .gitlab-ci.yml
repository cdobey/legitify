stages:
  - setup
  - invoke
  - query

variables:
  DOCKER_HOST: tcp://docker:2375
  DOCKER_TLS_CERTDIR: ""
  IMAGE_TAG: "20.10.16"

services:
  - name: docker:dind
    alias: docker

# Define a global before_script to avoid repetition (optional)
# You can uncomment the following lines if you prefer a global before_script
# before_script:
#   - apt-get update && apt-get install -y \
#       bash \
#       jq \
#       curl \
#       golang \
#       tar \
#       ca-certificates \
#       docker.io

setup_network:
  stage: setup
  image: ubuntu:20.04  # Use a glibc-based image
  before_script:
    # Update package lists and install necessary packages
    - apt-get update && apt-get install -y \
        bash \
        jq \
        curl \
        golang \
        tar \
        ca-certificates \
        docker.io  # Install Docker
    # Ensure Docker is running
    - service docker start
    # Create Docker runtime directory if necessary
    - mkdir -p /var/run/docker.sock
  script:
    # Navigate to the ledger source directory
    - cd src/ledger
    # Download and install Hyperledger Fabric binaries
    - curl -sSLO https://raw.githubusercontent.com/hyperledger/fabric/main/scripts/install-fabric.sh
    - chmod +x install-fabric.sh
    - ./install-fabric.sh docker binary --os linux --arch amd64
    # Navigate to the network directory and start the network
    - cd legitify-network
    - bash scripts/startNetwork.sh
    # Verify crypto material
    - |
      if [ ! -d "organizations/peerOrganizations/orguniversity.com/users/Admin@orguniversity.com/msp" ]; then
        echo "MSP path is missing. Ensure cryptogen or CA setup runs correctly."
        exit 1
      fi
  tags:
    - docker
  only:
    - main
    - merge_requests
  dependencies:
    # No dependencies for the first job

invoke_degree:
  stage: invoke
  image: ubuntu:20.04  # Use a glibc-based image
  before_script:
    # Update package lists and install necessary packages
    - apt-get update && apt-get install -y \
        bash \
        jq \
        curl \
        golang \
        tar \
        ca-certificates \
        docker.io  # Install Docker
    # Ensure Docker is running
    - service docker start
  script:
    # Navigate to the network directory and invoke the chaincode
    - cd src/ledger/legitify-network
    - bash scripts/invokeDegree.sh
  tags:
    - docker
  only:
    - main
    - merge_requests
  dependencies:
    - setup_network

query_degree:
  stage: query
  image: ubuntu:20.04  # Use a glibc-based image
  before_script:
    # Update package lists and install necessary packages
    - apt-get update && apt-get install -y \
        bash \
        jq \
        curl \
        golang \
        tar \
        ca-certificates \
        docker.io  # Install Docker
    # Ensure Docker is running
    - service docker start
  script:
    # Navigate to the network directory and query the chaincode
    - cd src/ledger/legitify-network
    - bash scripts/queryDegree.sh
  tags:
    - docker
  only:
    - main
    - merge_requests
  dependencies:
    - invoke_degree
