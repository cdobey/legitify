image: node:18

variables:
  SERVER_PID_FILE: "/tmp/server.pid"

test_flow:
  stage: test
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == "main"
    - if: $CI_COMMIT_BRANCH == "master"
  tags:
    - docker
  before_script:
    - echo $(whoami)
    - docker --version
    - echo "Runner is on x86_64 (Intel/AMD)."
    - cd $CI_PROJECT_DIR
    - git clean -fdx
    - sudo chown -R gitlab-runner:gitlab-runner .
  script:
    # 1. Setup Node environment
    - cd $CI_PROJECT_DIR/src/server
    - npm install

    # 2. Install and setup Fabric
    - cd $CI_PROJECT_DIR/src/ledger
    - export ARCH=amd64
    - export FABRIC_PATH=$PWD
    - bash ./install-fabric.sh --fabric-version 2.5.10 binary --ca-version 1.5.13
    - chmod +x bin/*

    # 3. Build and deploy network
    - cd chaincode/degreeChaincode
    - go mod tidy
    - cd $CI_PROJECT_DIR/src/ledger/legitify-network
    - bash scripts/stopNetwork.sh || true
    - bash scripts/startNetwork.sh
    - bash scripts/testDegreeChaincode.sh

    # 4. Start backend server
    - cd $CI_PROJECT_DIR/src/server
    - chmod +x src/scripts/start-fresh-db.sh
    - bash src/scripts/start-fresh-db.sh &

    # Wait for server to be ready
    - |
      timeout=60
      while ! curl -s http://localhost:3001/docs > /dev/null; do
        if [ "$timeout" -le "0" ]; then
          echo "Server failed to start"
          exit 1
        fi
        echo "Waiting for server to start... ($timeout seconds remaining)"
        timeout=$((timeout-1))
        sleep 1
      done
    - echo "Server is up and running!"
    # 5. Run test flow
    - chmod +x scripts/test-flow.sh
    - bash scripts/test-flow.sh

  after_script:
    # Cleanup everything
    - |
      # Stop backend server if running
      if [ -f "src/server/server.pid" ]; then
        kill $(cat src/server/server.pid) || true
        rm src/server/server.pid
      fi

      # Clean up database
      cd $CI_PROJECT_DIR/src/server
      docker-compose down -v
      rm -rf pgdata
      rm -rf src/wallet/*

      # Tear down Fabric network
      cd $CI_PROJECT_DIR/src/ledger/legitify-network
      ./network.sh down
      docker system prune -af --volumes

      # Cleanup files
      cd $CI_PROJECT_DIR
      sudo chown -R gitlab-runner:gitlab-runner .
      sudo find . -type d -exec chmod 755 {} +
      sudo find . -type f -exec chmod 644 {} +

  cache:
    paths:
      - src/server/node_modules/
