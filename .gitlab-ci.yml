# .gitlab-ci.yml

stages:
  - prepare
  - deploy
  - chaincode-test
  - cleanup

before_script:
  - docker info  # Verify Docker daemon connectivity

prepare:
  stage: prepare
  image: docker:20.10.16
  script:
    - echo "Preparing environment..."
    - apk add --no-cache bash jq curl
    - curl -L "https://github.com/docker/compose/releases/download/1.29.2/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
    - chmod +x /usr/local/bin/docker-compose
    - docker-compose --version
  tags:
    - docker
  only:
    - main
    - merge_requests

deploy_network:
  stage: deploy
  image: docker/compose:1.29.2
  script:
    - echo "Deploying Hyperledger Fabric network..."
    - cd ./src/ledger/legitify-network
    - chmod +x ./scripts/*.sh
    - ./scripts/startNetwork.sh
    - sleep 30  # Adjust based on network startup time
    - docker ps -a
  tags:
    - docker
  dependencies:
    - prepare
  only:
    - main
    - merge_requests

chaincode_test:
  stage: chaincode-test
  image: docker:20.10.16
  script:
    - echo "Running Chaincode Tests..."
    - cd ./src/ledger/legitify-network
    - ./scripts/invokeDegree.sh
    - ./scripts/queryDegree.sh
  tags:
    - docker
  dependencies:
    - deploy_network
  only:
    - main
    - merge_requests

cleanup:
  stage: cleanup
  image: docker/compose:1.29.2
  script:
    - echo "Cleaning up Fabric network..."
    - cd ./src/ledger/legitify-network
    - ./network.sh down
    - docker system prune -f
  tags:
    - docker
  when: always
  only:
    - main
    - merge_requests
