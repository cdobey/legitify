image: node:18-bullseye

variables:
  SERVER_PID_FILE: "/tmp/server.pid"

test_flow:
  stage: test
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == "main"
    - if: $CI_COMMIT_BRANCH == "master"
  tags:
    - shell
  before_script:
    # Install system dependencies
    - |
      sudo apt-get update && sudo apt-get install -y \
        curl \
        git \
        jq \
        docker.io \
        docker-compose \
        golang-go

    # Setup Node.js using NVM and global dependencies
    - |
      curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.0/install.sh | bash
      export NVM_DIR="$HOME/.nvm"
      [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"
      nvm install 18
      nvm use 18
      npm install -g typescript ts-node

    # Verify installations
    - node --version
    - npm --version
    - docker --version
    - go version

    # Prepare workspace
    - cd $CI_PROJECT_DIR
    - git clean -fdx
    - sudo chown -R gitlab-runner:gitlab-runner .

  script:
    # 1. Setup Node environment
    - cd $CI_PROJECT_DIR/src/server
    - npm ci # Use ci instead of install for cleaner, more reliable builds
    - npm install -g ts-node typescript # Ensure ts-node is available globally

    # 2. Install and setup Fabric
    - cd $CI_PROJECT_DIR/src/ledger
    - export ARCH=amd64
    - export FABRIC_PATH=$PWD
    - export PATH=$PATH:$FABRIC_PATH/bin
    - bash ./install-fabric.sh --fabric-version 2.5.10 binary --ca-version 1.5.13
    - chmod +x bin/*

    # 3. Build and deploy network
    - cd chaincode/degreeChaincode
    - GO111MODULE=on go mod vendor
    - cd $CI_PROJECT_DIR/src/ledger/legitify-network
    - bash scripts/stopNetwork.sh || true
    - bash scripts/startNetwork.sh
    - bash scripts/testDegreeChaincode.sh

    # 4. Start backend server and wait for it
    - |
      cd $CI_PROJECT_DIR/src/server
      chmod +x src/scripts/start-fresh-db.sh
      source src/scripts/start-fresh-db.sh

      # Wait for server to be fully ready
      echo "Waiting for server to be fully ready..."
      TIMEOUT=60
      while [ $TIMEOUT -gt 0 ]; do
        if curl -s http://localhost:3001/docs > /dev/null; then
          echo "Server is responding to requests"
          break
        fi
        echo "Waiting... ($TIMEOUT seconds remaining)"
        sleep 1
        TIMEOUT=$((TIMEOUT - 1))
      done

      if [ $TIMEOUT -eq 0 ]; then
        echo "Server failed to start properly"
        exit 1
      fi

    # 5. Run test flow with proper synchronous execution
    - |
      chmod +x scripts/test-flow.sh
      # Run tests in foreground and capture output
      TEST_OUTPUT_FILE="test_output.log"
      if ! bash scripts/test-flow.sh 2>&1 | tee $TEST_OUTPUT_FILE; then
        echo "Test flow failed"
        cat $TEST_OUTPUT_FILE
        exit 1
      fi

      # Verify test completion
      if ! grep -q "Test flow completed successfully!" $TEST_OUTPUT_FILE; then
        echo "Test flow did not complete successfully"
        cat $TEST_OUTPUT_FILE
        exit 1
      fi

      echo "All tests completed successfully"

  after_script:
    # Cleanup everything with proper process management
    - |
      set +e  # Continue on errors during cleanup
      echo "Starting cleanup..."

      # Function to kill process and its children
      kill_process_tree() {
        local pid=$1
        if [ -n "$pid" ]; then
          children=$(pgrep -P $pid)
          for child in $children; do
            kill_process_tree $child
          done
          kill -9 $pid 2>/dev/null || true
        fi
      }

      # Stop backend server
      if [ -f "$CI_PROJECT_DIR/src/server/server.pid" ]; then
        SERVER_PID=$(cat "$CI_PROJECT_DIR/src/server/server.pid")
        echo "Stopping server with PID $SERVER_PID"
        kill_process_tree $SERVER_PID
        rm -f "$CI_PROJECT_DIR/src/server/server.pid"
      fi

      # Clean up database and wallet
      cd $CI_PROJECT_DIR/src/server || true
      docker-compose down -v || true
      sudo rm -rf pgdata src/wallet/* || true

      # Tear down Fabric network
      cd $CI_PROJECT_DIR/src/ledger/legitify-network || true
      ./network.sh down || true
      docker system prune -af --volumes || true

      # Reset permissions
      cd $CI_PROJECT_DIR || true
      sudo chown -R gitlab-runner:gitlab-runner . || true
      sudo find . -type d -exec chmod 755 {} + || true
      sudo find . -type f -exec chmod 644 {} + || true

      echo "Cleanup completed"

  cache:
    key: ${CI_COMMIT_REF_SLUG}
    paths:
      - src/server/node_modules/
      - ~/.npm/
    policy: pull-push
