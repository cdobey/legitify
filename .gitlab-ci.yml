stages:
  - build
  - deploy

before_script:
  # If Docker is already running on the instance, you can skip starting it.
  - docker --version
  - echo "Runner is on x86_64 (Intel/AMD)."
  - cd $CI_PROJECT_DIR  # Ensure we are in the project directory where GitLab cloned the repo

build_chaincode:
  stage: build
  tags:
    - docker  # Or whatever tag matches your runner
  script:
    - echo "Copying AMD-based Fabric binaries into src/ledger/bin..."
    # 1. Remove old bin folder if it exists
    - rm -rf src/ledger/bin
    # 2. Copy your known-good binaries from hyperledger-fabric-linux-amd64-2.5.10
    - ./src/ledger/install-fabric.sh --fabric-version 2.5.10 binary --ca-version 1.5.13
    - pwd
    - ls
    - chmod +x src/ledger/bin/*
    
    # 3. (Optional) Build or tidy chaincode
    - echo "Tidying chaincode dependencies..."
    - cd src/ledger/chaincode/degreeChaincode
    - go mod tidy
    - echo "Chaincode build step complete."
  only:
    - main
    - master
    - merge_requests

deploy_fabric_network:
  stage: deploy
  tags:
    - docker
  script:
    - echo "Deploying the Fabric network..."
    - cd $CI_PROJECT_DIR/src/ledger/legitify-network
    
    # 1. Stop existing network if still running
    - bash scripts/stopNetwork.sh || true
    
    # 2. Start the network (includes chaincode deployment)
    - bash scripts/startNetwork.sh

    - echo "Network deployment step complete."
  only:
    - main
    - master
    - merge_requests
  dependencies:
    - build_chaincode
