stages:
  - prepare
  - setup

variables:
  DOCKER_HOST: tcp://docker:2375
  DOCKER_TLS_CERTDIR: ""

services:
  - name: docker:dind
    alias: docker

prepare:
  stage: prepare
  image: docker:stable
  before_script:
    # Install additional tools required for the pipeline
    - apk add --no-cache bash jq
  script:
    # Pull the necessary Docker images for Hyperledger Fabric
    - echo "Pulling Hyperledger Fabric Docker images..."
    - docker pull hyperledger/fabric-peer:2.5.10
    - docker pull hyperledger/fabric-orderer:2.5.10
    - docker pull hyperledger/fabric-ca:1.5.0

    # Copy the Fabric binaries and configuration files to the target directory
    - echo "Copying Hyperledger Fabric binaries and configuration files..."
    - cp -r src/ledger/hyperledger-fabric-linux-amd64-2.5.10/* src/ledger/

    # Verify that the binaries and configs were copied successfully
    - echo "Verifying copied binaries and configurations..."
    - ls -la src/ledger/bin
    - ls -la src/ledger/config

    # Make the binaries executable
    - echo "Making Fabric binaries executable..."
    - chmod -R +x src/ledger/bin

  # Artifacts to pass along to subsequent stages
  artifacts:
    paths:
      - src/ledger/bin
      - src/ledger/config

setup_network:
  stage: setup
  image: docker:stable
  script:
    - set -x  # Enable script debugging
    - cd src/ledger/legitify-network
    - bash scripts/startNetwork.sh
  tags:
    - docker
  only:
    - main
    - merge_requests
  dependencies:
    - prepare
  artifacts:
    paths:
      - src/ledger/legitify-network/logs/
      - src/ledger/legitify-network/channel-artifacts/
