stages:
  - setup
  - invoke
  - query

variables:
  DOCKER_HOST: tcp://docker:2375
  DOCKER_TLS_CERTDIR: ""

services:
  - docker:dind

setup_network:
  stage: setup
  image: debian:bullseye
  script:
    - apt-get update && apt-get install -y curl jq golang tar ca-certificates
    - curl -fsSL https://get.docker.com | bash  # Install Docker
    - service docker start  # Start Docker service
    - docker version       # Verify Docker installation
    - curl -sSLO https://raw.githubusercontent.com/hyperledger/fabric/main/scripts/install-fabric.sh && chmod +x install-fabric.sh
    - ./install-fabric.sh docker binary --os linux --arch amd64
    - cd legitify-network
    - bash scripts/startNetwork.sh
    # Verify crypto material
    - if [ ! -d "organizations/peerOrganizations/orguniversity.com/users/Admin@orguniversity.com/msp" ]; then
        echo "MSP path is missing. Ensure cryptogen or CA setup runs correctly.";
        exit 1;
      fi
  tags:
    - docker
  only:
    - main
    - merge_requests

invoke_degree:
  stage: invoke
  image: debian:bullseye
  script:
    - apt-get update && apt-get install -y curl jq golang tar ca-certificates
    - curl -fsSL https://get.docker.com | bash  # Install Docker
    - service docker start  # Start Docker service
    - cd src/ledger/legitify-network
    - bash scripts/invokeDegree.sh
  tags:
    - docker
  only:
    - main
    - merge_requests
  dependencies:
    - setup_network

query_degree:
  stage: query
  image: debian:bullseye
  script:
    - apt-get update && apt-get install -y curl jq golang tar ca-certificates
    - curl -fsSL https://get.docker.com | bash  # Install Docker
    - service docker start  # Start Docker service
    - cd src/ledger/legitify-network
    - bash scripts/queryDegree.sh
  tags:
    - docker
  only:
    - main
    - merge_requests
  dependencies:
    - invoke_degree
