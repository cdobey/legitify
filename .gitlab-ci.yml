stages:
  - setup
  - invoke
  - query

# Required to allow Docker-in-Docker
variables:
  DOCKER_TLS_CERTDIR: ""
  # Remove or comment out if not needed:
  # DOCKER_HOST: tcp://docker:2375 

# Docker-in-Docker service
services:
  - name: docker:dind
    alias: docker

# -----------------------------------------
# Stage 1: Setup network
# -----------------------------------------
setup_network:
  stage: setup
  image: ubuntu:20.04  # Use a glibc-based image
  before_script:
    # Update packages and install dependencies, including Docker
    - apt-get update && apt-get install -y apt-utils
    - apt-get install -y bash jq curl golang tar ca-certificates docker.io
    # Start Docker service
    - service docker start
  script:
    - cd src/ledger
    # Install Fabric binaries
    - curl -sSLO https://raw.githubusercontent.com/hyperledger/fabric/main/scripts/install-fabric.sh
    - chmod +x install-fabric.sh
    - ./install-fabric.sh docker binary --os linux --arch amd64

    # Start the Hyperledger Fabric network
    - cd legitify-network
    - bash scripts/startNetwork.sh

    # Verify crypto materials
    - |
      if [ ! -d "organizations/peerOrganizations/orguniversity.com/users/Admin@orguniversity.com/msp" ]; then
        echo "MSP path is missing. Ensure cryptogen or CA setup runs correctly."
        exit 1
      fi
  tags:
    - docker
  only:
    - main
    - merge_requests

# -----------------------------------------
# Stage 2: Invoke degree
# -----------------------------------------
invoke_degree:
  stage: invoke
  image: ubuntu:20.04
  before_script:
    - apt-get update && apt-get install -y apt-utils
    - apt-get install -y bash jq curl golang tar ca-certificates docker.io
    - service docker start
  script:
    - cd src/ledger/legitify-network
    - bash scripts/invokeDegree.sh
  tags:
    - docker
  only:
    - main
    - merge_requests
  dependencies:
    - setup_network

# -----------------------------------------
# Stage 3: Query degree
# -----------------------------------------
query_degree:
  stage: query
  image: ubuntu:20.04
  before_script:
    - apt-get update && apt-get install -y apt-utils
    - apt-get install -y bash jq curl golang tar ca-certificates docker.io
    - service docker start
  script:
    - cd src/ledger/legitify-network
    - bash scripts/queryDegree.sh
  tags:
    - docker
  only:
    - main
    - merge_requests
  dependencies:
    - invoke_degree
